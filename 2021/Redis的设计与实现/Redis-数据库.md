[TOC]

# Redis 数据库

## 服务器中的数据库

- 服务器`redisServer`将所有的数据库保存在`db`数组中。
- `db`数组每项都为`redisDb`结构，一个`redisDb`结构代表一个数据库。
- `dbnum`属性代表服务器中数据库的数量。
- 默认数量为16。

## 切换数据库

- 使用`SELECT`命令切换数据库。默认使用0号数据库。
- 客户端`redisClient`中的`db`记录了正在使用的数据库。
- 当客户端`redisClient`和服务端`redisServer`两个指针指向不同的`db`。通过`SELECT`命令修改客户端的指针。
- 为了避免对数据库误操作，建议在执行相关写操作或修改命令前，使用`SELECT`命令显式地切换到指定数据库。

## 数据库键空间

- 数据库主要由`dict`和`expires`两个字典构成，其中`dict`字典负责保存键值对，而`expires`字典则负责保存键的过期时间。
- 因为数据库由字典构成，所以对数据库的操作都是建立在字典操作之上的。
- `redisDb`保存着数据库中的所有键值对，为数据库键空间。
- 键总是一个字符串对象，而值则可以是任意一种`Redis`对象。
- 除了基本的添加、删除、更新、取值操作之外，很多针对数据库本身的`Redis`命令，也都是通过对键空间进行处理来完成。

### 键空间的维护操作

1. 读取一个键后，更新键的命中（`hit`）次数，或不命中（`miss`）次数。
2. 读取一个键后，更新键的`LRU`时间，该时间可以用于计算键的闲置时间。
3. 服务器在读取一个键后，发现该键已经过期，那么服务器会先删该键，然后才执行余下操作。
4. 若客户端使用`WATCH`命令监视了某个键，当服务器修改该键时，则会标记该键为脏（`dirty`）。
5. 服务器每修改一个键后，都会对脏键计数器（`dirty`）+1，这个计数器会触发服务器的持久化及复制操作。
6. 若服务器开启了数据库通知功能，那么对键修改之后，将会按配置发送相应的数据库通知。

## 键的生存时间或过期时间

### 设置过期时间

- `Redis`有四种不同的命令可以用于设置键的生存时间或过期时间。`EXPIRE`,`PEXPIRE`,`EXPIREAT`,`PEXPIREAT`。
- 无论是四个命令中的哪一个，实际上都是转换成`PEXPIREAT`命令——timestamp所指定的毫秒数时间戳。

### 保存过期时间

> redisDb结构的expires字典保存了数据库中所有键的过期时间，我们称这个字典为过期字典。
> 
- 过期字典的键是一个指针，这个指针指向键空间中的某个键对象（也即是某个数据库键）。
- 过期字典的值是一个`long long`类型的整数，这个整数保存了键所指向的数据库键的过期时间——一个毫秒精度的`UNIX`时间戳。
- 键空间保存了数据库中的所有键值对，而过期字典则保存了数据库键的过期时间。
- 键空间的键和过期字典的键都指向==同一个键对象==，所以==不会出现任何重复对象，也不会浪费任何空间==。

### 过期键的判定

- 判定一个键是否过期
    1. 检查给定键是否存在过期字典，若存在，则取得过期时间。
    2. 检查当前`UNIX`时间戳是否大于键的过期时间：若是，则过期；不是，则未过期。

## 过期删除键策略

- **定时删除**：设置键的过期时间的同时，创建一个定时器，在键过期时间来临时，立即执行对键的删除操作。
- **惰性删除**：放任键的过期时间不管，每次从键空间中获取键时，都检查过期时间，若过期，则删除该键。
- **定期删除**：每隔一段时间，对数据库进行检查，删除其中的过期键。要删除多少过期键，以及要检查多少个数据库，则由算法决定。
- 惰性删除为被动删除策略，其余两种为主动删除策略。
- **定时删除**占用过多的`CPU`时间，影响服务器的响应时间和吞吐量；**惰性删除**浪费太多内存，有内存泄露的风险；**定期删除**的难点是确定操作执行的时长和频率。
- `Redis`使用==惰性删除==和==定期删除==策略来删除过期的键。

## 持久化及复制对过期键的处理

### RDB

- 已过期的键不会保存到新生成的`RDB`文件。
- 服务器以主服务器模式运行，未过期的键会被载入到数据库中，过期键则会被忽略；以从服务器模式运行，所有键无论是否过期，都会被载入到数据库中。

### AOF

- 当某个键已过期但未被删除，`AOF`文件不会受影响。当该键被删除后，系统会向`AOF`文件追加一条命令，显式地记录该键已被删除。
- 在执行`AOF`重写的过程中，已过期的键不会被保存到重写后的`AOF`文件中。

### 复制

- 主服务器删除一个过期键后，会向所有从服务器发送一条命令，显式地删除过期键。
- 从服务器发现过期键也不主动删除，而是等待主服务器的命令。这种方式能保证数据的一致性。