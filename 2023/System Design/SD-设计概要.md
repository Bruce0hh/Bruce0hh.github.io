[TOC]

# System Design Interview

> 本文列举了在系统设计面试中需要考虑的方面。

## 使用哪一种数据库

我们可以在传统的关系型数据库和 NoSQL 数据库之间进行选择。

在以下几种情况，NoSQL 数据库是更好的选择：

- 你的系统要求超低延迟。
- 你的数据是非结构化的，或者是你没有任何关系型的数据。
- 你只需要对数据（JSON、XML、YAML等）进行序列化和反序列化的操作。
- 你需要存储大量的数据。

## 垂直扩展和水平扩展

- 垂直扩展指的是针对服务器添加更多资源的一种做法。
- 水平扩展可透过像是在“资源池”添加更多服务器的做法，来达到扩展的效果。

当流量还比较低的时候，垂直扩展是一种不错的选择，垂直扩展本身的简单性就是它主要的优点，然而这种做法也有严重的局限性。

- 垂直扩展有硬件上的限制。我们不可能在一个服务器上，无限地添加更多的CPU和内存。
- 垂直扩展并没有故障转移与提供冗余的效果。如果一个服务器出现了故障，网络/APP就完全无法使用了。

所以对于大规模的系统来说，水平扩展是更常用的方法。

## 负载均衡器

负载均衡器会把进来系统的流量，以一种很均衡的方式，分散到负载均衡组合内定义的几个服务器。

用户会直接连到负载均衡器的外网IP。这样设定下，客户端就无法直接连接到Web服务器，服务器之间都是透过内网IP进行沟通，而在 Internet 外网的机器，则无法直接对内网进行存取。所有外部设备都必须先连往负载均衡器，才能透过内网IP与Web服务器进行沟通。

## 数据库重写机制

这里指通过数据库以主从模型的方式实现重写机制。

数据库重写机制的优点：

- **更好的性能**：在主从模型中，所有写入与更新都只会发生在主节点；读取操作则会分散到各个从节点。这个模型可提高性能上的表现，因为这样系统就能以平行的方式处理更多的查询。
- **可靠性**：不用担心数据丢失，因为已经事先在多个位置进行了备份。
- **高可用性**：由于数据跨越不同位置进行了复制，因此就算其中有某个数据库离线，你的网站还是可以正常运作，因为我们还是可以存取到另一个数据库服务器所保存的数据。

如果其中一个数据库离线了会怎样？

- 如果只有一个从数据库可用，可是它已经离线，读取操作就会暂时被导向主数据库。一旦找到了问题，新的从数据库就会取代掉旧的从数据库。如果有多个从数据库可用，则会把读取操作重新导向到其他正常的从数据库。新的数据库服务器也会取代掉旧的数据库服务器。
- 如果主数据库离线，其中一个从数据库就会升级为新的主数据库。所有数据库操作都会暂时在新的主数据库上执行。新的从数据库也会立即进行数据复制，以取代旧的数据库。在生产环境中，还有要考虑数据复原等一系列问题。

## 缓存

使用缓存的一些注意事项：

- **判断何时该使用缓存**：如果数据非常频繁被读取，但又不经常进行修改，就可以考虑使用缓存。由于缓存会把数据储存在很容易丢失内存中，因此缓存服务器并不是长久存储数据的理想选择。当缓存服务器一旦重启，内存所有数据都会丢失。所以重要的数据还是应该保存在持久性数据存储系统中。
- **过期策略**：给缓存数据设置一个过期策略。缓存数据过期后，就会从内存中移除。如果没有过期策略，缓存数据就会永远保存在内存中。过期时间不要太短，因为这样会导致系统从数据库重新载入数据的次数过于频繁。过期时间不要太长，因为数据可能早就过时了。
- **一致性**：如何让数据库的数据和缓存数据同步。
- **减轻故障的影响**：尽量跨越不同的数据中心，使用多个缓存服务器，以避免出现单点故障。或者在单一服务器下，按照一定的百分比，以超额的方式提供所需的内存。
- **淘汰策略**：内存一旦满了之后，如果再把新的数据加入到缓存中，就可能导致旧的数据被移除。常见的淘汰策略有 LRU、LFU或FIFO。
- 