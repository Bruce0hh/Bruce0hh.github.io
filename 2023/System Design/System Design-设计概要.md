[TOC]

# System Design Interview

> 本文列举了在系统设计面试中需要考虑的方面。

## 使用哪一种数据库

我们可以在传统的关系型数据库和 NoSQL 数据库之间进行选择。

在以下几种情况，NoSQL 数据库是更好的选择：

- 你的系统要求超低延迟。
- 你的数据是非结构化的，或者是你没有任何关系型的数据。
- 你只需要对数据（JSON、XML、YAML等）进行序列化和反序列化的操作。
- 你需要存储大量的数据。

## 垂直扩展和水平扩展

- 垂直扩展指的是针对服务器添加更多资源的一种做法。
- 水平扩展可透过像是在“资源池”添加更多服务器的做法，来达到扩展的效果。

当流量还比较低的时候，垂直扩展是一种不错的选择，垂直扩展本身的简单性就是它主要的优点，然而这种做法也有严重的局限性。

- 垂直扩展有硬件上的限制。我们不可能在一个服务器上，无限地添加更多的CPU和内存。
- 垂直扩展并没有故障转移与提供冗余的效果。如果一个服务器出现了故障，网络/APP就完全无法使用了。

所以对于大规模的系统来说，水平扩展是更常用的方法。

## 负载均衡器

负载均衡器会把进来系统的流量，以一种很均衡的方式，分散到负载均衡组合内定义的几个服务器。

用户会直接连到负载均衡器的外网IP。这样设定下，客户端就无法直接连接到Web服务器，服务器之间都是透过内网IP进行沟通，而在 Internet 外网的机器，则无法直接对内网进行存取。所有外部设备都必须先连往负载均衡器，才能透过内网IP与Web服务器进行沟通。

## 数据库重写机制

这里指通过数据库以主从模型的方式实现重写机制。

数据库重写机制的优点：

- **更好的性能**：在主从模型中，所有写入与更新都只会发生在主节点；读取操作则会分散到各个从节点。这个模型可提高性能上的表现，因为这样系统就能以平行的方式处理更多的查询。
- **可靠性**：不用担心数据丢失，因为已经事先在多个位置进行了备份。
- **高可用性**：由于数据跨越不同位置进行了复制，因此就算其中有某个数据库离线，你的网站还是可以正常运作，因为我们还是可以存取到另一个数据库服务器所保存的数据。

如果其中一个数据库离线了会怎样？

- 如果只有一个从数据库可用，可是它已经离线，读取操作就会暂时被导向主数据库。一旦找到了问题，新的从数据库就会取代掉旧的从数据库。如果有多个从数据库可用，则会把读取操作重新导向到其他正常的从数据库。新的数据库服务器也会取代掉旧的数据库服务器。
- 如果主数据库离线，其中一个从数据库就会升级为新的主数据库。所有数据库操作都会暂时在新的主数据库上执行。新的从数据库也会立即进行数据复制，以取代旧的数据库。在生产环境中，还有要考虑数据复原等一系列问题。

## 缓存

使用缓存的一些注意事项：

- **判断何时该使用缓存**：如果数据非常频繁被读取，但又不经常进行修改，就可以考虑使用缓存。由于缓存会把数据储存在很容易丢失内存中，因此缓存服务器并不是长久存储数据的理想选择。当缓存服务器一旦重启，内存所有数据都会丢失。所以重要的数据还是应该保存在持久性数据存储系统中。
- **过期策略**：给缓存数据设置一个过期策略。缓存数据过期后，就会从内存中移除。如果没有过期策略，缓存数据就会永远保存在内存中。过期时间不要太短，因为这样会导致系统从数据库重新载入数据的次数过于频繁。过期时间不要太长，因为数据可能早就过时了。
- **一致性**：如何让数据库的数据和缓存数据同步。
- **减轻故障的影响**：尽量跨越不同的数据中心，使用多个缓存服务器，以避免出现单点故障。或者在单一服务器下，按照一定的百分比，以超额的方式提供所需的内存。
- **淘汰策略**：内存一旦满了之后，如果再把新的数据加入到缓存中，就可能导致旧的数据被移除。常见的淘汰策略有 LRU、LFU或FIFO。

## CDN（内容分发网络）

> CDN指的是一些在地理位置上分散各处的服务器所构成的网络，可用来分发一些不会经常变动的内容。CDN服务器会针对一些像是图片、影片、CSS、JavaScript等这类静态内容进行缓存。

- **CDN工作原理**：当使用访问网站时，距离使用者最近的CDN服务器就会负责提供静态内容。
- **工作流程**：
  1. 使用者A尝试透过图片的URL网址索取`image.png`。URL的域名是由CDN供应商所提供。以下两个图片的URL网址，分别是图片在 Amazon 与 Akamai CDN 上响应的URL网址范例：
     - `https://mysite.cloudfront.net/logo.jpg`
     - `https://mysite.akamai.com/image-manager/img/logo.jpg`
  2. 如果CDN服务器的缓存内没有 `image.png`，CDN服务器就会向来源处请求数据，这个来源处有可能是一个Web服务器，也有可能是 Amazon S3 这类的线上储存服务。
  3. 图片原始来源会把 image.jpg 送回给CDN服务器，其中HTTP报文头可能会包含可有可无的TTL存活时间设定，说明此图片可以在多长时间内透过缓存来进行存取。
  4. CDN缓存这张图片并把它送回给使用者A。在TTL过期之前，图片会一直保留在CDN中。
  5. 使用者B发送请求，想要索取相同的图片。
  6. 只要TTL尚未过期，就会从缓存送回图片。

### 注意事项

- **成本**：CDN是由第三方供应商所提供，你只要向CDN上传或下载数据，都会被收取费用。针对不经常使用的东西进行缓存，并不会带来任何明显的好处，因此你就应该考虑把它移出CDN。
- **为缓存设定适当的过期时间**：对于时间很敏感的内容，设定缓存的过期时间就特别重要。缓存的过期时间不应该太长或太短。如果太长，内容可能无法保持更新。如果太短，则有可能导致CDN过于频繁从原始服务器重新载入内容。
- **CDN的 fallback **：使用CDN应该考虑如何应对CDN出问题的情况。如果CDN暂时故障，客户端应该要能够侦测到该问题，并改向原始来源处请求资源。
- **使数据无效化**：只要执行以下一项操作，就可以在CDN的缓存过期之前，从CDN中移除数据：
  - 使用CDN供应商所提供的API，让CDN对象无效化；
  - 使用对象版本控制，以提供不同版本的对象。如果要对对象进行版本控制，可以在URL网址内添加参数（例如版本号）。

## 无状态网络层

> 考虑到 Web 层的水平扩展，我们必须把状态移出 Web 层。其中一种做法就是把 session 数据储存在关系型数据库或是 NoSQL 之类的持久型储存系统中。集群内的每个 Web 服务器都可以从数据库存取到状态数据。这就是所谓的无状态（stateless）Web层。

### 有状态架构

有状态服务器和无状态服务器有一些关键的区别。有状态服务器在一个请求到另一个请求之间，会记住客户端的状态数据，而无状态服务器则不会保留任何状态记录。

### 无状态架构

将 session 数据之类的移出 Web 层，并把它存储在持久型数据库系统中，可选用关系型数据库或 NoSQL，使用NoSQL 可更方便进行扩展。自动扩展就是可以根据流量负载的大小，自动添加或移除 Web 服务器。Web 服务器移除掉状态数据后，就可以根据流量大小来添加或移除服务器，轻松实现服务器的扩展。

## 消息队列

消息队列是一种保存在硬盘上的可持久化对象，可以用于作非同步通讯。主要是用来作为一个缓冲区，负责分发各种非同步请求。消息队列的基本架构很简单。生产者服务会建立消息，将消息发布到消息队列中，其它服务器作为消费者服务则会连接到队列，然后执行所定义的消息。

由于天生具有解耦的效果，因此消息队列成为了打造可扩展又可靠的系统架构首选。有了消息队列之后，生产者就可以把消息发布到队列中，就算消费者无法立刻处理消息也没关系，而且就算生产者暂时无法运行，消费者还是可以继续通过队列获取消息。

## 数据库扩展

### 垂直扩展

同服务器扩展，数据库的垂直扩展也有一样的缺点：

- 可以为数据库服务器添加 CPU、内存、硬盘等，但是用户量非常多，只有一台服务器可能就不够用了。
- 单点故障的风险较大。
- 扩展成本较高，性能强大的服务器，价格更加昂贵。

### 水平扩展

水平扩展则称为分片（sharding），它采用的是添加更多服务器的做法。

分片的做法就是把大型的数据库分成好几个比较小的，更易管理的分片。每个分片共用相同的数据库表结构，不过每个分片里实际的数据，对于该分片来说都是唯一且不重复的。

选择分片策略的时候，所要考虑的最重要的因素就是分片键的选择。分片键也叫做分区键，它是由一或多个栏位所构成，可用来判断数据分配的方式。选择分片键最重要的标准之一，就是要能均匀分散数据的分布。

### 分片的挑战

- **数据的重新分片**：
  1. 如果数据快速增加，单一分片不再能容纳更多数据时，就需要对数据进行重新分片。
  2. 如果数据分布不均，其中某些分片有可能会比其他分片更快消耗存储空间。如果消耗了某个分片，就需要修改分片函数，重新移动数据。常用于解决此问题的方法时一致性哈希的算法。
- **名人问题**：也称作热点问题。针对特定分片出现过多的存取，有可能就会导致服务器超载的问题。如果想解决这个问题，可能就必须针对每一个热点分配一个分片。每个分片甚至有可能还需要进一步分区。
- **JOIN 联结与反范式**：一旦数据库跨越了多个服务器进行了分片之后，就很难跨越不同数据库分片执行JOIN操作。常见的做法就是反范式化，以便能够在单一数据库中执行操作。

## 总结

- 让 Web 层保持无状态
- 让每一层保留一定的冗余
- 尽可能多缓存常用数据
- 用 CDN 托管静态资料
- 利用分片扩展数据层
- 把各层切分成单独的服务
- 监控系统并善用自动化工具

