[TOC]

# 数据链路层

## 数据链路层三个重要问题

> 封装成帧和透明传输、差错检测、可靠传输

### 封装成帧和透明传输

#### 封装成帧

- 封装成帧就是给网络成交付下来的分组添加一个首部和尾部，这样就构成了一个帧。
- 帧首带有帧开始符和控制信息；而帧尾往往带有帧结束符和控制信息。
- 考虑到缓存空间和差错控制等因素，每种数据链路层协议都规定了帧的数据载荷长度上限，即最大传送单元（Maximum Transfer Unit，MTU）。

#### 透明传输

1. 字节填充
2. 比特填充

在没有帧界定符的情况下，数据链路层通常使用**帧间间隔+8字节前导码**来提取一个帧。

### 差错检测

1. 奇偶校验
2. CRC（循环冗余校验）

### 可靠传输

#### 停止等待协议SW（Stop-and-Wait）

![image-20220821223443574](https://gcore.jsdelivr.net/gh/Bruce0hh/Bruce0hh.github.io/pic-bed/image-20220821223443574.png)

- 为了让接收方判断数据分组是否重复，数据分组需要编号，只需1个比特编号就够了，即编号0和1。
- 为了让发送方判断ACK分组是否重复，ACK分组需要和数据分组同样的编号，但是由于SW协议的停等特性，因此在数据链路层实现SW协议可以不用给ACK分组编号。
- 超时计时器设置的重传时间，应该设置为略大于“发送方到接收方的平均往返时间”。
- 通过使用确认和重传这两个机制，进行错误纠正的协议，称为ARQ协议，即自动重传请求（Automatic Repeat-reQuest）。**SW属于停止等待ARQ协议**。

#### 回退N帧协议GBN（Go-Back-N）

- 发送窗口尺寸W~r~的取值范围是$1<W~t~\leqslant2^n-1$，其中n是分组序号的比特数量。
  - $W~t~=1$，SW协议。
  - $W~t~>2^n-1$，接收方无法辨析新、旧数据分组。
- 接收窗口尺寸W~R~的取值范围是$W~t~=1$。
- GBN在流水线传输的基础上利用发送窗口来限制发送方连续发送数据分组的数量，是一种**连续ARQ协议**。
- 在协议工作过程中，发送窗口和接收窗口不断向前滑动，因此这类协议又称为滑动窗口协议。
- 当通信线路质量不好时，GBN信道的利用率不比SW高。

#### 选择重传协议

- 发送窗口尺寸W~r~的取值范围是$1<W~t~\leqslant2^n-1$，其中n是分组序号的比特数量。
  - $W~t~=1$，SW协议。
  - $W~t~>2^n-1$，接收方无法辨析新、旧数据分组。
- 接收窗口尺寸W~R~的取值范围是$1<W~r~\leqslant W~t~$，其中n是分组序号的比特数量。
  - $W~r~=1$，SW协议。
  - $W~r~>2^n-1$，无意义。
- 发送方只有按序收到对已发送的数据分组确认时，发送窗口才能向前相应滑动。**发送方可在未收到接收方确认分组的情况下，将序号落在发送窗口的多个数据分组全部发送出去**。
- 接收方只有按序接收数据分组后，接收窗口才能向前相应滑动。**接收方必须对每个正确接收到的数据分组进行逐一确认**。

![image-20220822214633526](https://gcore.jsdelivr.net/gh/Bruce0hh/Bruce0hh.github.io/pic-bed/image-20220822214633526.png)

## MAC地址、IP地址和ARP协议

> MAC地址是对网络上各接口的唯一标识，而不是对网络上各设备的唯一标识。

### MAC地址结构

MAC地址为48比特构成，每4个比特写成一个十六进制的字符，每两个字符一组（共6组）。

![image-20220821162620740](https://gcore.jsdelivr.net/gh/Bruce0hh/Bruce0hh.github.io/pic-bed/image-20220821162620740.png)

- IEEE规定MAC地址的第一个字节的b0位为 I/G（Individual/Group）位。
  - 当 I/G 位为0时，MAC为单播地址。
  - 当 I/G 位为1时，MAC为多播地址。
- IEEE规定MAC地址的第一个字节的b1位为 G/L（Global/Local）位。
  - 当 G/L 位为0时，MAC为全球管理地址。
  - 当 G/L 位为1时，MAC为本地管理地址。

**四种地址类型说明**

1. 全球单播地址：由厂商生产网络设备时固化在设备中的。
2. 全球多播地址：交换机和路由器等标准网络设备所支持的多播地址，用于特定功能。
3. 本地单播地址：由网络管理员分配，可以覆盖网络接口的全球单播地址。
4. 本地多播地址：由用户对网卡编程的实现，以表名其属于哪些多播组。

### IP地址

- MAC地址不具备区分不同网络的功能。
  - 如果只是一个单独的网络，不介入因特网，可以只使用MAC地址。
  - 如果主机所在的网络要接入因特网，则IP地址和MAC地址都需要使用。
- 数据包转发过程中IP地址和MAC地址的变化情况：
  - 源IP地址和目的IP地址保持不变；
  - 源MAC地址和目的MAC地址逐个链路改变。

### ARP协议

- **源主机**通过在自己的ARP高速缓存表中，查找目的主机的IP地址所对应的MAC地址，若找到了，则可以封装在MAC帧进行发送；若找不到，则发送到==ARP请求（封装在广播MAC帧中）==。
- **目的主机**收到ARP请求后，将源主机的IP地址与MAC地址记录到自己的ARP告诉缓存表中，然后给源主机发送==ARP响应（封装在单播MAC帧中）==，包含目的主机的IP地址和MAC地址。
- ARP作用范围：逐段链路或逐个网络使用。
- ARP没有安全验证机制，存在ARP欺骗（攻击）问题。

## VLAN（虚拟局域网）

> 虚拟局域网（Virtual Local Area Network，VLAN）是一种将局域网内的站点划分成与物理位置无关的逻辑组技术，一个逻辑组就是一个VLAN。

属于同一个VLAN的站点之间可以直接进行通信，而不属于同一VLAN的站点之间不能直接通信。

划分VLAN有以下好处：

- 控制广播风暴：通过划分VLAN将局域网分隔成若干个独立的广播域，这样可以控制广播风暴。
- 方便网络管理：VLAN迁移不需要改变物理位置，只需要在相关交换机上调整VLAN配置即可。
- 增强网络安全：网络管理员可以根据用户的安全需求来隔离VLAN间的通信。

### VLAN的实现

- IEEE 802.1Q帧对以太网的MAC帧格式进行了扩展，插入了4字节的VLAN的标记。

  ![image-20220821221905625](https://gcore.jsdelivr.net/gh/Bruce0hh/Bruce0hh.github.io/pic-bed/image-20220821221905625.png)

- VLAN标记的最后12比特称为VLAN标识符VID，它唯一地标志了以太网帧属于哪一个VLAN。
  - VID的有效取值范围是1~4094.
- **802.1Q帧是由交换机来处理的，而不是用户主机来处理的**。
  - 当交换机**收到普通的以太网帧**时，会将其插入4字节的VLAN标记转变为802.1Q帧，简称“打标签”。
  - 当交换机**转发802.1Q帧**时，**可能**会删除其4字节VLAN标记转变为普通以太网帧，简称为“去标签”。

#### 交换机端口

##### Access

- 连接用户计算机
- 只能属于一个VLAN
- PVID与端口所属VLAN的ID相同，默认值为1
- 接收处理方法：一般只接受未打标签的普通以太网帧，并给其打标签。
- 发送处理方法：若帧中的VID等于端口PVID，则去掉标签并转发；否则丢弃。

##### Trunk

- 交换机之间或交换机与路由器之间的连接
- 可以属于多个VLAN
- 用户可以设置PVID，默认为1
- 接收处理方法：接收已打标签的帧；接收未打标签的帧，根据端口的PVID值给帧打标签。
- 发送处理方法：帧中VID等于端口PVID，去掉标签再转发；帧中VID不等于端口PVID，直接转发。

##### Hybrid

- 交换机之间、交换机与路由器、交换机与用户计算机之间的连接
- 可以属于多个VLAN
- 用户可以设置PVID，默认为1
- 接收处理方法：接收已打标签的帧；接收未打标签的帧，根据端口的PVID值给帧打标签。
- 发送处理方法：查看数据帧中的VID是否在端口的“去标签”列表中
  - 如果存在，则去掉标签再转发；
  - 如果不存在，则直接转发。