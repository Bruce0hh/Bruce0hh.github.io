[TOC]

# 网络层（三）

## 路由选择协议

|              |                 | 具体协议                    | 说明                                                         |
| :----------: | --------------- | --------------------------- | ------------------------------------------------------------ |
| 路由选择协议 | 内部网关协议IGP | 路由信息协议RIP             | **基于距离向量**：RIP在因特网上最早使用                      |
|              |                 | 内部网关路由协议IGRP        | **基于距离向量**：IGRP是思科早期私有的协议，现在已被EIGRP取代 |
|              |                 | 增强型内部网关路由协议EIGRP | **结合距离向量和链路状态**：思科私有的协议，用来取代IGRP的混合型路由协议 |
|              |                 | 开放式最短路径优先OSPF      | **基于链路状态**：OSPF在各种网络中广泛使用                   |
|              |                 | 中间系统到中间系统IS-IS     | **基于链路状态**：集成化IS-IS是ISP骨干网上最长常用的IGP协议  |
|              | 外部网关协议EGP | 边界网关协议BGP             |                                                              |



## 路由信息协议RIP的基本工作原理

- 路由信息协议RIP（Routing Infomation Protocol）是内部网关协议IGP中最先得到广泛使用的协议之一。
- RIP要求自治系统AS内的每一个路由器都要维护从它自己到AS内其他每一个网络的距离记录。这是一组距离，称为“距离向量”。
- RIP使用**跳数（Hop Count）作为度量（Metric）来衡量到达目的网络的距离**。
  - 路由器到直连网络的距离定义为1。
  - 路由器到非直连网络的距离定义为所经过的路由器数+1。
  - 允许一条路径最多只能包含15个路由器。“距离”等于16时相当于不可达。因此，**RIP只适用于小型互联网**。
- RIP认为好的路由就是“距离短”的路由，也就是所通过路由器数量最少的路由。
- 当到达同一目的网络有多条“距离相等”的路由时，可以进行等价负载均衡。
- RIP包含以下三个要点：
  - 和谁交换信息：仅和相邻路由器交换信息
  - 交换什么信息：自己的路由表
  - 何时交换信息：周期性交换（例如每30秒）
- **RIP的基本工作过程**
  1. 路由器刚开始工作时，只知道自己到直连网络的距离为1。
  2. 每个路由器仅和相邻路由器周期性地交换并更新路由信息。
  3. 若干次交换和更新后，每个路由器都知道到达本AS内各网络的最短距离和下一跳地址，称为收敛。
- **RIP的路由条目的更新规则**
  - 发现了新的网络，添加。
  - 到达目的网络，相同下一跳，最新消息，更新。
  - 到达目的网络，不同下一跳，新路由优势，更新。
  - 到达目的网络，不同下一跳，等价负载均衡。
  - 到达目的网络，不同下一跳，新路由劣势，不更新。
- RIP存在“坏消息传播得慢”的问题。
- “坏消息传播得慢”又称为路由环路或距离无穷计数的问题，这是距离向量算法的一个固有问题。可以采取多种措施减少出现该问题的概率或减小该问题带来的危害。
  - 限制最大路径距离为15（16表示不可达）。
  - 当路由表发生变化时就立即发送更新报文（即“触发更新”），而不仅是周期性发送。
  - 让路由器记录收到某特定路由信息的接口，而不让同一路由信息再通过此接口向反方向传送（即“水平分割”）。

## 开放最短路径OSPF的基本工作原理

- 开放最短路径优先OSPF（Open Shortest Path First），是为克服RIP的缺点在1989年开发出来的。

  - “开放”表明OSPF协议不是某一家厂商控制，而是公开发表的。
  - “最短路径优先”是因为使用了 Dijkstra 提出的最短路径算法SPF。

- OSPF是基于链路状态的，而不像RIP那样是基于向量的。

- OSPF采用SPF算法计算路由，从算法上保证了不会产生路由环路。

- OSPF不限制网络规模，更新频率高，收敛速度快。

- 链路状态是指本路由器都和那些路由器相邻，以及响应链路的代价（cost）。

  - “代价”用来表示费用、距离、时延、带宽，等等。这些都由网络管理人员来决定。

- 使用OSPF的每个路由器都会产生链路状态通告LSA（Link State Advertisement）。

  LSA包含以下内容：

  - 直连网络的链路状态信息
  - 邻居路由器的链路状态信息

- LSA被封禁在链路状态更新分组LSU中，采用洪泛法发送。

- 使用OSPF的每个路由器都有一个链路状态数据库LSDB，用于存储LSA。

- 通过各路由器泛洪发送封装有自己LSA的LSU分组，各路由器最终将达到其他路由器的最短路径，即构建各自的路由表。

- OSPF有以下五种分组类型

  - 问候（Hello）分组
  - 数据库描述（Database Description）分组
  - 链路状态（Link State Acknowledgment）分组
  - 链路状态更新（Link State Update）分组
  - 链路状态确认（Link State Acknowledge）分组

- OSPF在多点接入网络中路由器邻居关系的建立

  - 选举指定路由器DR（designated router）和备用的指定路由器BDR（backup designated router）
  - 所有的非DR/BDR只与DR/BDR建立邻居关系
  - 非DR/BDR
  - 之间通过DR/BDR交换信息

- 为了使OSPF能够用于规模很大的网络，OSPF把一个自治系统在划分为若干个更小的范围，叫做区域（Area）。

- 划分区域的好处就是把利用洪泛法交换链路状体信息的范围局限于每一个区域而不是整个自治系统，这就减少了整个网络上的通信量。



## 边界网关协议BGP的基本工作原理

- 外部网关协议EGP（例如边界网关协议BGP）
  - 在不同自治系统内，度量路由的“代价”（距离，带宽，费用等）可能不同。因此，对于自治系统之间的路由选择，使用“代价”作为度量来寻找最佳路由是不行的。
  - 自治系统之间的路由选择必须考虑相关策略（政治，经济，安全等）。
  - BGP只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。
- 在配置BGP时，每个自治系统的管理员要选择至少一个路由器作为该自治系统的“BGP发言人”。
- 不同自治系统的BGP发言人要交换路由信息，首先必须建立TCP连接，端口号179
  - 在此TCP连接上交换BGP报文以建立BGP会话。
  - 利用BGP会话交换路由信息（例如，增加新的路由，或撤销过时的路由，以及报告出错的情况等）。
  - 使用TCP连接交换路由信息的两个BGP发言人，彼此称为对方的邻站（neighbor）或对等站（peer）。
- BGP发言人除了运行BGP外，还必须运行自己所在自治系统所使用的内部网关协议IGP，例如OSPF或RIP。
- BGP发言人交换网络可达性的信息（哟啊到达某个网络所要经过的一系列自治系统）。
- 当BGP发言人互相交换了网络可达性的信息后，各BGP发言人就根据所采用的策略从收到的路由信息中找出到达各自治系统的较好的路由。也就是构造出树形结构、不存在回路的自治系统连通图。
- BGP适用于多级结构的因特网
- BGP-4有以下四种报文
  - OPEN（打开）报文：用来与相邻的另一个BGP发言人建立关系，使通信初始化。
  - UPDATE（更新）报文：用来通告某一路由的信息，以及列出要撤销的多条路由。
  - KEEPALIVE（保活）报文：用来周期性地证实邻站的连通性。
  - NOTIFICATION（通知）报文：用来发送检测到的差错。
