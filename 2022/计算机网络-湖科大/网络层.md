[TOC]

# 网络层（一）

## IPv4地址及其编址方法

IPv4地址采用点分十进制的表示方法以方便用户的使用。

**将某个32bit的IPv4地址中每8bit分为一组，写出每组8bit所对应的十进制数，每个十进制数之间用`.`来分隔，就可以得到该IPv4地址的点分十进制形式**。

### 分类编址

![image-20220910121750495](https://cdn.jsdelivr.net/gh/Bruce0hh/Bruce0hh.github.io/pic-bed/image-20220910121750495.png)



- 网络号：用来标志主机（或路由器）的接口所连接到的网络。
- 主机号：用来标志主机（或路由器）的接口。

#### 注意

1. 只有A类、B类和C类地址可分配给网络中的主机或路由器的各接口。
2. 主机号为“全0”的地址是网络地址，不能分配给主机或路由器的各接口。
3. 主机号为“全1”的地址是广播地址，不能分配给主机或路由器的各接口。

#### 地址细节

![image-20220910122333403](https://cdn.jsdelivr.net/gh/Bruce0hh/Bruce0hh.github.io/pic-bed/image-20220910122333403.png)

1. 从IPv4地址的左起第一个十进制数，判断网络类别：
   - 127以下的为A类
   - 128~191的为B类
   - 192~223的为C类
2. 以下三种情况的地址是不能分配给主机或路由器接口的：
   - A类地址的网络号为0或127
   - 主机号全0的网络地址
   - 主机号全1的广播地址

![image-20220910122843864](https://cdn.jsdelivr.net/gh/Bruce0hh/Bruce0hh.github.io/pic-bed/image-20220910122843864.png)



### 划分子网

使用新网络号而非子网的弊端：

- 需要等待时间和花费更多的费用
- 会增加其他路由器中路由表记录的数量
- 浪费原有网络号中剩余的大量IP地址

可以从IPv4地址的主机号部分借用一些bit作为子网号，来区分不同的子网，就可以利用原有网络中剩余的大量IPv4地址，而不用申请新的网络地址了。

#### 子网掩码

**32bit的子网掩码可以表明分类IP地址的主机号部分被借用了几个bit作为子网号**。

- 子网掩码使用连续的比特1来对应网络号和子网号
- 子网掩码使用连续的比特0来对应主机号
- 将划分子网的IPv4地址与其相对应的子网掩码进行逻辑与运算就可得到IPv4地址所在子网的网络地址

![image-20220910124102013](https://cdn.jsdelivr.net/gh/Bruce0hh/Bruce0hh.github.io/pic-bed/image-20220910124102013.png)



**默认子网掩码是指在未划分子网的情况下使用的子网掩码**。

![image-20220910125745647](https://cdn.jsdelivr.net/gh/Bruce0hh/Bruce0hh.github.io/pic-bed/image-20220910125745647.png)



### 无分类编址

> 无分类域间路由选择（Classless Inter-Domain Routing, CIDR）

- CIDR消除了传统的A类、B类和C类地址，以及划分子网的概念。
- CIDR可以更加有效地分配IPv4的地址空间。
- CIDR使用“斜线记法”，或称CIDR记法。即在IPv4地址后面加上斜线`/`，在斜线之后写上网络前缀所占的比特数量。
- CIDR实际上是将网络前缀都相同的连续的IP地址组成一个“CIDR地址块”。
- 路由聚合（构造超网）的方法时找共同前缀。
- 网络前缀越长，地址块越小，路由越具体。
- 若路由表查表转发分组时发现有多条路由可选，则选择网络前缀最长的那条，这称为最长前缀匹配，因为这样的路由更具体。

**以`128.14.35.7/20`为例**

![image-20220910163030534](https://cdn.jsdelivr.net/gh/Bruce0hh/Bruce0hh.github.io/pic-bed/image-20220910163030534.png)



## IPv4的应用规划

#### 定长的子网掩码（Fixed Length Subnet Mask, FLSM）

- 使用同一个子网掩码来划分子网
- 子网划分方式不灵活：只能划分$2^n$个子网（n是从主机号部分借用的用来作为子网号的比特数量）
- 每个子网所分配的IP地址数量相同，容易造成IP地址浪费

#### 变长的子网掩码（Variable Length Subnet Mask，VLSM）

- 使用不同的子网掩码来划分子网
- 子网划分方式灵活：可以按需分配
- 每个子网所分配的IP地址数量可以不同，尽可能减少对IP地址的浪费



## IPv4数据报的首部格式

![image-20220910220158642](https://cdn.jsdelivr.net/gh/Bruce0hh/Bruce0hh.github.io/pic-bed/image-20220910220158642.png)

（概念居多，了解即可）

1. **版本**：占4bit，表示IP协议的版本。通信双方使用的IP协议的版本必须一致。目前广泛使用的IP协议版本号为4（即IPv4）。

2. **首部长度**：占4bit，表示IP数据报首部的长度。该字段的取值以4字节为单位。

   - 最小十进制取值为5，表示IP数据报首部的长度只有20字节固定部分；
   - 最大十进制取值为15，表示IP数据报首部包含20字节固定部分和最大40字节可变部分。

3. **可选字段**：长度从1个字节到40个字节不等。用来支持排错、测量及安全等措施。实际上该字段很少被使用。

4. **填充字段**：确保首部长度为4字节的整数倍。使用全0进行填充。

5. **区分服务**：占8bit，用来获得更好的服务。利用该字段的不同数值可提供不同等级的服务质量。只有在使用区分服务时，该字段才起作用。一般都不使用该字段。

6. **总长度**：占16bit，表示IP数据报的总长度（首部+数据载荷）。最大取值为十进制的65535，以字节为单位。

7. **标识**：占16bit，属于同一个数据报的各分片数据报应该具有相同的标识。IP软件维持一个计数器，每产生一个数据报，计数器值+1，并将此值赋给标识字段。

8. **标志**：占3bit，各bit含义如下：

   - DF：1表示不允许分片；0表示允许分片；
   - MF：1表示后面还有分片；0表示这是最后一个分片；
   - 保留位：必须为0。

9. **片偏移**：占13bit，指出分片数据报的数据载荷部分偏移其在原数据报的位置有多少个的那位。片偏移以8个字节为单位。

10. **生存时间**：占8bit，表示IP数据报的生存时间。

    - 最初以秒为单位，最大生存周期为255秒；路由器转发IP数据报时，将IP数据报首部中的该字段的值减去IP数据报在本路由器上所耗费的时间，若不为0就转发，否则就丢弃。
    - 现在以“跳数”为单位，路由器转发IP数据报时，将IP数据报首部中的该字段的值减1，若不为0就转发，否则就丢弃。
    - IP数据报每经过一个路由器，路由器都要重新计算首部校验和，因为某些字段（生存时间、标志、片偏移）的取值可能发生变化。

11. **协议**：占8bit，指明IPv4数据报的数据部分是何种协议数据单元。常用的一些协议和响应的协议字段值如下：

    |  协议名称  | ICMP | IGMP | TCP  | UDP  | IPv6 | OSPF |
    | :--------: | :--: | :--: | :--: | :--: | :--: | :--: |
    | 协议字段值 |  1   |  2   |  6   |  17  |  41  |  89  |

12. **首部校验和**：占16bit，用来检测首部在传输过程中是否出现差错。比CRC检验码简单，称为因特网检验和。
13. **源IP地址和目的IP地址**：各占32bit，用来填写发送该IP数据报的源主机的IP地址和接收该IP数据报的目的主机的IP地址。

## IP数据报的发送和转发过程

### 主机发送IP数据报

判断目的主机是否与自己在同一个网络（判断通过CIDR划分的前缀部分是否相等）

- 在同一个网络，属于直接交付
- 不在同一个网络，属于间接交付，传输给主机所在网络的默认网关（路由器），由默认网关帮忙转发
- 上述不考虑通过ARP协议获取MAC地址的过程

### 路由器转发数据报

1. 检查IP数据报首部是否出错
   - 出错：直接丢弃该IP数据报并通告源主机
   - 没有出错：进行转发
2. 根据IP数据报的目的地址在路由表中查找匹配的条目
   - 找到：转发给条目中指示的下一跳
   - 找不到：丢弃该IP数据报并通告源主机

