[TOC]

# 网络层（二）

## ICMP（Internet Control Message Protocol）

> 为了更有效地转发IP数据报和提高交付成功的机会，在网际层使用了网际控制报文协议。

- 主机或路由器使用ICMP来发送**差错报告报文**和**询问报文**。

- **ICMP报文被封装在IP数据报**中发送。

- ICMP差错报告报文共有以下五种：

  - **终点不可达**：当路由器或主机==不能交付IP数据报==时，就向源点发送终点不可达报文。
  - **源点抑制**：当路由器或主机==由于拥塞而丢弃IP数据报==时，就向源点发送源点抑制报文，使源主机知道应当把IP数据报的发送速率放慢。
  - **时间超时（超时）**：当路由器收到一个==目的IP地址不是自己的IP数据报==时，会将首部中生存时间（TTL）字段的值减1。
  - **参数问题**：当路由器或目的主机收到IP数据报后，根据其首部中的校验和字段的值发现==首部在传送过程中出现了误码==，就丢弃该数据，并向源点发送参数问题报文。
  - **改变路由**（重定向）：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器，这样可以通过更好的路由到达目的主机。

- 以下情况不应发送ICMP差错报告报文：

  - 对ICMP差错报文不再发送ICMP差错报文。
  - 对第一个分片的IP数据报片的所有后续数据报片都不发送ICMP差错报告报文。
  - 对具有多播地址的IP数据报都不发送ICMP差错报告报文。
  - 对具有特殊地址（127.0.0.0或0.0.0.0）的数据报不发送ICMP差错报告报文。

- 常用ICMP询问报文有以下两种：

  - **回送请求和回答**

    回送请求和回答报文由主机或路由器向一个特定的目的主机或路由器发出。收到此报文的主机或路由器必须给源主机或路由器发送ICMP回送回答报文。这种询问报文用来测试目的站是否可达以及了解其有关状态。

  - **时间戳请求和回答**

    时间戳请求和回答报文用来请求某个主机或路由器回答当前的日期和时间。时间戳请求和回答报文被用来进行时钟同步和测量时间。

- ICMP应用：

  - **分组网间探测PING**（Packet InterNet Groper）

    永安里测试主机或路由器之间的连通性。PING是TCP/IP体系结构的应用层直接使用网际层ICMP的一个例子，它并不使用运输层的TCP或UDP。PING应用所使用的ICMP报文类型为回送请求和回答。

  - **跟踪路由tranceroute**

    跟踪路由traceroute应用，用于探测IP数据报从源主机到达目的主机要经过那些路由器。

## 虚拟专用网VPN与网络地址转换NAT

### 虚拟专用网VPN（Virtual Private Network）

- 利用公用的因特网作为本机构各专用之间的通信载体，这样的专用网又称为==虚拟专用网==。
- 同一机构内不同部门的内部网络所构成的虚拟专用网VPN又称为==内联网VPN==。
- VPN要保证传输数据的安全性，会将原始的内部数据报进行加密，然后再将其封装成为在因特网上发送到的外部数据报。
- 有时一个机构的VPN需要有某些外部机构参加进来。这样的VPN就称为==外联网VPN==。
- 在外地工作的员工需要访问公司内部的专用网时，只要在任何地点接入到因特网，运行驻留在员工PC中的VPN软件，在员工的PC和公司的主机之间建立VPN隧道，即可访问专用网络中的资源。这种VPN称为==远程接入VPN==。

### 网络地址转换NAT（Network Address Translation）

- NAT能使大量使用内部专用地址的专用网络用户共享少量外部全球地址来访问因特网上的主机和资源。
- 由于绝大多数的网络应用都是使用运输层的端口号和IP地址一起进行转换。这样，用一个全球IP地址就可以使多个拥有本地地址的主机同时和因特网上的主机进行通信。这种将端口和IP地址一起进行转化的技术叫做用**网络地址与端口号转换NAPT（Network Address and Port Translation）**。
- 对于一些P2P网络应用，需要外网主机主动与内网主机进行通信，在通过NAT时会遇到问题，需要网络应用自己使用一些特殊的NAT穿越技术来解决问题。
- 由于NAT对外网屏蔽了内网主机的网络地址，能为内网的主机提供一定的安全保护。

## IP多播技术

- 多播（Multicast，也称为组播）是一种实现“一对多”通信的技术，与传统单播“一对一”通信相比，多播可以极大地节省网络资源。
- 在因特网上进行的多播，称为IP多播。
- 在IPv4中，D类地址被作为多播地址（224.0.0.0~239.255.255.255）。
- 多播地址只能用作目的地址，而不能用作源地址。
- 用每一个D类地址来标识一个多播组，使用同一个IP多播地址接收IP多播数据报的所有主机就构成了一个多播组。
  - 每个多播组的成员是可以随时变动的，一台主机可以随时加入或离开多播组。
  - 多播组成员的数量和所在的地理位置也不受限制，一台主机可以属于几个多播组。
- 非多播组成员也可以向多播组发送IP多播数据报。
- 与IP数据报相同，IP多播数据报也是“尽最大努力交付”，不保证一定能够交付给多播组内的所有成员。
- IPv4多播地址又可分为预留的多播地址（永久多播地址）、全球范围可用的多播地址以及本地管理的多播地址。

### 硬件多播

- 由于MAC地址有多播MAC地址这种类型，因此只要把==IPv4多播地址映射成多播MAC地址==，即可将IP多播数据报封装在局域网的MAC帧中。MAC帧首部中的目的MAC地址字段的值，就设置为由IPv4多播地址映射成的多播MAC地址。这样，可以很方便地==利用硬件多播来实现局域网内的IP多播==。
- 当给某个多播组的成员主机配置其所属多播组的IP多播地址时，系统就会根据映射规则从该IP多播地址生成相应的局域网多播MAC地址。
- 因特网号码指派管理局IANA，将自己从IEEE注册管理机构申请到的以太网MAC地址块中从`01-00-5E-00-00-00`到`01-00-5E-7F-FF-FF`的多播MAC地址，用于映射IPv4多播地址。这些==多播MAC地址的左起前25个bit都是相同的==，剩余23个bit可以任意变化，因此共有$2^23$个。
- 由于IP多播地址可变化的28bit的前5个bit无法映射到MAC多播地址的低23bit，这会造成==IP多播地址与多播MAC地址的映射关系并不会是唯一的==。

### 因特网IP多播的两种协议

#### 多播路由选择协议

- 多播路由选择协议的主要任务是：在多播路由器之间为每个多播组建立一个多播转发树。
  - 多播转发树==连接多播源和所有拥有该多播组成员的路由器==。
  - IP多播数据报只要沿着多播转发树进行洪泛，就能被传送到所有拥有该多播组成员的多播路由器。
  - 在多播路由器所直连的局域网内，多播路由器通过硬件多播，将多播数据报发送给该多播组的所有成员。

- 针对不同的多播组需要维护不同的多播转发树，而且必须动态地适应多播组成员的变化，但此时网络拓扑并不一定发生变化，因此多播路由选择协议比单播路由选择协议（RIP、OSPF等）复杂得多。
- 即使某个主机不是任何多播组的成员，它也可以向任何多播组发送多播数据报。
- 为了覆盖多播组的所有成员，多播转发树可能要经过一些没有多播组成员的路由器。

#### IGMP（网际组管理协议，Internet Group Management Protocol）

- IGMP是TCP/IP体系结构网际层中的协议，其作用是==让连接在本地局域网上的多播路由器知道本局域网上是否有主机（实际上是主机中的某个进程）加入或退出了某个多播组==。
- ==IGMP仅在本网络有效==，使用IGMP并不能知道多播组所包含的成员数量，也不能知道多播组的成员都分布在哪些网络中。
- ==仅使用IGMP并不能在因特网上进行IP多播==。连接在局域网上的多播路由器还必须和因特网上的其它多播路由器协同工作，以便把IP多播数据报用最小的代价传送给所有的多播组成员，这就需要使用多播路由选择协议。

### IGMP详解

- 封装了IGMP报文的IP多播数据报的组成分为两部分：==IP首部+IGMP报文==。其中IP首部包含：
  1. **协议字段**：值为2，表示数据载荷部分是IGMP报文。
  2. **目的地址字段**：根据IGMP报文类型各有不同，但都属于IP多播地址。
  3. **生成时间TTL字段**：值为1，避免封装IGMP报文的IP多播数据报被路由器转发到其他网络。

- IGMP有三种报文类型：
  - 成员报告报文
  - 离开组报文
  - 成员查询报文

#### IGMP工作原理

- **加入多播组**

  当一个主机（中的某个进程）要加入某个多播组时，该主机会向其所在网络发送一个封装有==IGMP成员报告报文==的IP多播数据报。

- **监视多播组成员变化**

  多播路由器默认每隔125秒就向其直连网络发送一个封装有==IGMP成员查询报文==的IP多播数据报。多播路由器如果长时间未收到某个多播组的成员报告，则将该多播组从自己的多播组列表中删除。

- **退出多播组**

  当主机要退出某个多播组时，可主动发送一个==离开组报文==而不必等待多播路由器的查询。这样可以使多播路由器能够更快地发现某个多播组有成员离开。

  多播路由器在收到离开组报文时==不能立即将多播组从自己的多播组列表中删除==，因为在本网络中可能还有该多播组的其他成员。因此，该多播路由器收到离开组报文后，会立即==针对该多播组发送一个IGMP成员查询报文==。若在预定时间内没有收到IGMP成员报告报文，才将该多播组从自己的多播组列表中删除。

