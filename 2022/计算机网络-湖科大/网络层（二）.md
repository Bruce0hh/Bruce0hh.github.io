[TOC]

# 网络层（二）

## ICMP（Internet Control Message Protocol）

> 为了更有效地转发IP数据报和提高交付成功的机会，在网际层使用了网际控制报文协议。

- 主机或路由器使用ICMP来发送**差错报告报文**和**询问报文**。

- **ICMP报文被封装在IP数据报**中发送。

- ICMP差错报告报文共有以下五种：

  - **终点不可达**：当路由器或主机==不能交付IP数据报==时，就向源点发送终点不可达报文。
  - **源点抑制**：当路由器或主机==由于拥塞而丢弃IP数据报==时，就向源点发送源点抑制报文，使源主机知道应当把IP数据报的发送速率放慢。
  - **时间超时（超时）**：当路由器收到一个==目的IP地址不是自己的IP数据报==时，会将首部中生存时间（TTL）字段的值减1。
  - **参数问题**：当路由器或目的主机收到IP数据报后，根据其首部中的校验和字段的值发现==首部在传送过程中出现了误码==，就丢弃该数据，并向源点发送参数问题报文。
  - **改变路由**（重定向）：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器，这样可以通过更好的路由到达目的主机。

- 以下情况不应发送ICMP差错报告报文：

  - 对ICMP差错报文不再发送ICMP差错报文。
  - 对第一个分片的IP数据报片的所有后续数据报片都不发送ICMP差错报告报文。
  - 对具有多播地址的IP数据报都不发送ICMP差错报告报文。
  - 对具有特殊地址（127.0.0.0或0.0.0.0）的数据报不发送ICMP差错报告报文。

- 常用ICMP询问报文有以下两种：

  - **回送请求和回答**

    回送请求和回答报文由主机或路由器向一个特定的目的主机或路由器发出。收到此报文的主机或路由器必须给源主机或路由器发送ICMP回送回答报文。这种询问报文用来测试目的站是否可达以及了解其有关状态。

  - **时间戳请求和回答**

    时间戳请求和回答报文用来请求某个主机或路由器回答当前的日期和时间。时间戳请求和回答报文被用来进行时钟同步和测量时间。

- ICMP应用：

  - **分组网间探测PING**（Packet InterNet Groper）

    永安里测试主机或路由器之间的连通性。PING是TCP/IP体系结构的应用层直接使用网际层ICMP的一个例子，它并不使用运输层的TCP或UDP。PING应用所使用的ICMP报文类型为回送请求和回答。

  - **跟踪路由tranceroute**

    跟踪路由traceroute应用，用于探测IP数据报从源主机到达目的主机要经过那些路由器。

## 虚拟专用网VPN与网络地址转换NAT

### 虚拟专用网VPN（Virtual Private Network）

- 利用公用的因特网作为本机构各专用之间的通信载体，这样的专用网又称为==虚拟专用网==。
- 同一机构内不同部门的内部网络所构成的虚拟专用网VPN又称为==内联网VPN==。
- VPN要保证传输数据的安全性，会将原始的内部数据报进行加密，然后再将其封装成为在因特网上发送到的外部数据报。
- 有时一个机构的VPN需要有某些外部机构参加进来。这样的VPN就称为==外联网VPN==。
- 在外地工作的员工需要访问公司内部的专用网时，只要在任何地点接入到因特网，运行驻留在员工PC中的VPN软件，在员工的PC和公司的主机之间建立VPN隧道，即可访问专用网络中的资源。这种VPN称为==远程接入VPN==。

### 网络地址转换NAT（Network Address Translation）

- NAT能使大量使用内部专用地址的专用网络用户共享少量外部全球地址来访问因特网上的主机和资源。
- 由于绝大多数的网络应用都是使用运输层的端口号和IP地址一起进行转换。这样，用一个全球IP地址就可以使多个拥有本地地址的主机同时和因特网上的主机进行通信。这种将端口和IP地址一起进行转化的技术叫做用**网络地址与端口号转换NAPT（Network Address and Port Translation）**。
- 对于一些P2P网络应用，需要外网主机主动与内网主机进行通信，在通过NAT时会遇到问题，需要网络应用自己使用一些特殊的NAT穿越技术来解决问题。
- 由于NAT对外网屏蔽了内网主机的网络地址，能为内网的主机提供一定的安全保护。

## IP多播技术

- 多播（Multicast，也称为组播）是一种实现“一对多”通信的技术，与传统单播“一对一”通信相比，多播可以极大地节省网络资源。
- 在因特网上进行的多播，称为IP多播。
- 在IPv4中，D类地址被作为多播地址（224.0.0.0~239.255.255.255）。
- 多播地址只能用作目的地址，而不能用作源地址。
- 用每一个D类地址来标识一个多播组，使用同一个IP多播地址接收IP多播数据报的所有主机就构成了一个多播组。
  - 每个多播组的成员是可以随时变动的，一台主机可以随时加入或离开多播组。
  - 多播组成员的数量和所在的地理位置也不受限制，一台主机可以属于几个多播组。
- 非多播组成员也可以向多播组发送IP多播数据报。
- 与IP数据报相同，IP多播数据报也是“尽最大努力交付”，不保证一定能够交付给多播组内的所有成员。
- IPv4多播地址又可分为预留的多播地址（永久多播地址）、全球范围可用的多播地址以及本地管理的多播地址。